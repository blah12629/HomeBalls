@inherits HomeBallsComponentBase
@inject IHomeBallsLocalStorageDataSource Data
@inject IHomeBallsLocalStorageEntryCollection Entries
@inject IHomeBallsEntryTableFactory TableFactory

@if (Table == default)
{
    <Loading Size="@LoadingImageSize.GlobalLinkSmall">
        <Message>
            <span>@Message</span>
        </Message>
    </Loading>
}

else
{
    <table class="table-fixed">
        <thead>
            <EntryHeader BallIds="@BallIds" />
        </thead>

        <tbody>
            @foreach (var column in Table.Columns)
            {
                <EntryColumn Column="@column" />
            }
        </tbody>
    </table>
}

@code {
    String? _message = "Downloading data...";

    IHomeBallsEntryTable? Table { get; set; }

    String? Message
    {
        get => _message;
        set { _message = value; StateHasChanged(); }
    }

    IReadOnlyList<UInt16>? BallIds => Table?.Columns
        .FirstOrDefault()?
        .Select(cell => cell.BallId)?
        .ToList().AsReadOnly();

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        await SetTableAsync();
    }

    async Task SetTableAsync()
    {
        await Task.Delay(200);
        await DownloadDataAsync();

        Message = "Generating table...";
        var tableStart = DateTime.Now;
        Table = await TableFactory.CreateTableAsync(new HomeBallsEntryCollection());
        Console.WriteLine(DateTime.Now - tableStart);

        foreach (var entry in Entries) Table.Add(entry);
    }

    async Task DownloadDataAsync()
    {
        var delay = 100;
        await executeAsync(Data.EnsureLoadedAsync(data => data.Items), "Downloaded items.");
        await executeAsync(Data.EnsureLoadedAsync(data => data.PokemonForms), "Downloaded forms.");
        await executeAsync(Data.EnsureLoadedAsync(data => data.PokemonSpecies), "Downloaded species.");
        await executeAsync(Entries.EnsureLoadedAsync(), "Downloaded entries.");

        async Task executeAsync<T>(ValueTask<T> ensureLoadedTask, String message)
        {
            var startTime = DateTime.Now;
            await ensureLoadedTask;
            writeElapsed(startTime);
            await Task.Delay(delay);
        }

        static void writeElapsed(DateTime start) =>
            Console.WriteLine(DateTime.Now - start);
    }
}